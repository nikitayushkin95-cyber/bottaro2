<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã–±–æ—Ä –∫–∞—Ä—Ç –¢–∞—Ä–æ</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <!-- Background with mystical pattern -->
    <div class="background" id="background"></div>
    
    <!-- Main container -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="title">üîÆ –í—ã–±–µ—Ä–∏—Ç–µ 3 –∫–∞—Ä—Ç—ã</h1>
            <p class="subtitle">–ö–æ—Å–Ω–∏—Ç–µ—Å—å –∫–∞—Ä—Ç, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∏—Ö –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–∞</p>
        </div>
        
        <!-- Selection counter -->
        <div class="selection-counter">
            <span class="selected-count" id="selectedCount">0 / 3</span>
        </div>
        
        <!-- Cards grid -->
        <div class="cards-grid" id="cardsContainer">
            <!-- Cards will be generated by JavaScript -->
        </div>
        
        <!-- Selected cards section -->
        <div class="selected-cards-section" id="selectedCardsSection" style="display: none;">
            <h3 class="selected-title">–í–∞—à–∏ –∫–∞—Ä—Ç—ã</h3>
            <div class="selected-cards" id="selectedCards">
                <!-- Selected cards will be shown here -->
            </div>
        </div>
        
        <!-- Action buttons -->
        <div class="action-buttons">
            <button class="continue-button" id="continueButton" style="display: none;">
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚ú®
            </button>
            <button class="get-reading-button" id="getReadingButton" style="display: none;">
                –ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–∫–ª–∞–¥
            </button>
        </div>
        
        <!-- Loading state -->
        <div class="loading" id="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç...</p>
        </div>
        
        <!-- Error state -->
        <div class="error" id="error" style="display: none;">
            <p>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ä—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.</p>
        </div>
    </div>

    <script>
        // Telegram WebApp initialization
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // Set theme colors
        tg.setHeaderColor('#0a0a0a');
        tg.setBackgroundColor('#0a0a0a');
        
        // Available cards data
        const availableCards = [
            { slug: 'the_fool', name: '–î—É—Ä–∞–∫', emoji: 'üÉè' },
            { slug: 'the_magician', name: '–ú–∞–≥', emoji: 'üé©' },
            { slug: 'the_high_priestess', name: '–í–µ—Ä—Ö–æ–≤–Ω–∞—è –ñ—Ä–∏—Ü–∞', emoji: 'üåô' },
            { slug: 'the_empress', name: '–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞', emoji: 'üëë' },
            { slug: 'the_emperor', name: '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä', emoji: '‚öîÔ∏è' },
            { slug: 'the_lovers', name: '–í–ª—é–±–ª–µ–Ω–Ω—ã–µ', emoji: 'üíï' },
            { slug: 'justice', name: '–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å', emoji: '‚öñÔ∏è' },
            { slug: 'the_hermit', name: '–û—Ç—à–µ–ª—å–Ω–∏–∫', emoji: 'üïØÔ∏è' },
            { slug: 'the_world', name: '–ú–∏—Ä', emoji: 'üåç' },
            { slug: 'wheel_of_fortune', name: '–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã', emoji: 'üé°' },
            { slug: 'queen_of_pentacles', name: '–ö–æ—Ä–æ–ª–µ–≤–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π', emoji: 'üí∞' },
            { slug: 'six_of_swords', name: '–®–µ—Å—Ç–µ—Ä–∫–∞ –ú–µ—á–µ–π', emoji: '‚öîÔ∏è' }
        ];
        
        // App state
        let selectedCards = [];
        const maxCards = 3;
        
        // DOM elements
        const cardsContainer = document.getElementById('cardsContainer');
        const selectedCount = document.getElementById('selectedCount');
        const continueButton = document.getElementById('continueButton');
        const getReadingButton = document.getElementById('getReadingButton');
        const selectedCardsSection = document.getElementById('selectedCardsSection');
        const selectedCardsContainer = document.getElementById('selectedCards');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        
        // Initialize app
        function init() {
            try {
                shuffleCards();
                renderCards();
                updateUI();
            } catch (err) {
                console.error('Initialization error:', err);
                showError();
            }
        }
        
        // Shuffle cards array
        function shuffleCards() {
            for (let i = availableCards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [availableCards[i], availableCards[j]] = [availableCards[j], availableCards[i]];
            }
        }
        
        // Render cards in the container
        function renderCards() {
            cardsContainer.innerHTML = '';
            
            // Show only 6 cards for better UX
            const cardsToShow = availableCards.slice(0, 6);
            
            cardsToShow.forEach((card, index) => {
                const cardElement = createCardElement(card, index);
                cardsContainer.appendChild(cardElement);
            });
        }
        
        // Create individual card element
        function createCardElement(card, index) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card';
            cardDiv.dataset.slug = card.slug;
            
            cardDiv.innerHTML = `
                <div class="card-face card-back"></div>
                <div class="card-face card-front">
                    <div class="card-image">${card.emoji}</div>
                    <div class="card-name">${card.name}</div>
                </div>
            `;
            
            cardDiv.addEventListener('click', () => handleCardClick(card, cardDiv));
            
            return cardDiv;
        }
        
        // Handle card click
        function handleCardClick(card, cardElement) {
            if (cardElement.classList.contains('selected')) {
                // Deselect card
                deselectCard(card, cardElement);
            } else if (selectedCards.length < maxCards) {
                // Select card
                selectCard(card, cardElement);
            } else {
                // Max cards reached, show feedback
                tg.HapticFeedback.notificationOccurred('error');
                showMaxCardsMessage();
            }
        }
        
        // Select a card
        function selectCard(card, cardElement) {
            selectedCards.push({
                slug: card.slug,
                name: card.name,
                emoji: card.emoji,
                reversed: Math.random() < 0.3 // 30% chance for reversed
            });
            
            cardElement.classList.add('selected', 'flipped');
            tg.HapticFeedback.selectionChanged();
            
            updateUI();
        }
        
        // Deselect a card
        function deselectCard(card, cardElement) {
            selectedCards = selectedCards.filter(c => c.slug !== card.slug);
            cardElement.classList.remove('selected', 'flipped');
            tg.HapticFeedback.selectionChanged();
            
            updateUI();
        }
        
        // Update UI based on current state
        function updateUI() {
            // Update counter
            selectedCount.textContent = `${selectedCards.length} / ${maxCards}`;
            
            // Show/hide continue button
            if (selectedCards.length === maxCards) {
                continueButton.style.display = 'block';
                selectedCardsSection.style.display = 'block';
                updateSelectedCardsDisplay();
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                continueButton.style.display = 'none';
                selectedCardsSection.style.display = 'none';
            }
        }
        
        // Update selected cards display
        function updateSelectedCardsDisplay() {
            selectedCardsContainer.innerHTML = '';
            
            selectedCards.forEach(card => {
                const selectedCardDiv = document.createElement('div');
                selectedCardDiv.className = 'selected-card';
                selectedCardDiv.innerHTML = `
                    <div style="font-size: 16px; margin-bottom: 5px;">${card.emoji}</div>
                    <div style="font-size: 8px; text-align: center;">${card.name}</div>
                    ${card.reversed ? '<div style="font-size: 6px; color: #ff6b6b;">–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è</div>' : ''}
                `;
                selectedCardsContainer.appendChild(selectedCardDiv);
            });
        }
        
        // Show max cards message
        function showMaxCardsMessage() {
            const message = document.createElement('div');
            message.className = 'error';
            message.textContent = `–ú–∞–∫—Å–∏–º—É–º ${maxCards} –∫–∞—Ä—Ç!`;
            message.style.position = 'fixed';
            message.style.top = '50%';
            message.style.left = '50%';
            message.style.transform = 'translate(-50%, -50%)';
            message.style.zIndex = '1000';
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                if (document.body.contains(message)) {
                    document.body.removeChild(message);
                }
            }, 2000);
        }
        
        // Show error state
        function showError() {
            loading.style.display = 'none';
            error.style.display = 'block';
            cardsContainer.style.display = 'none';
        }
        
        // Handle continue button click
        continueButton.addEventListener('click', () => {
            if (selectedCards.length === maxCards) {
                // Hide continue button and show get reading button
                continueButton.style.display = 'none';
                getReadingButton.style.display = 'block';
                tg.HapticFeedback.notificationOccurred('success');
            }
        });
        
        // Handle get reading button click
        getReadingButton.addEventListener('click', () => {
            try {
                // Send data to Telegram
                const data = {
                    cards: selectedCards.map(card => ({
                        slug: card.slug,
                        reversed: card.reversed
                    }))
                };
                
                tg.sendData(JSON.stringify(data));
                tg.close();
            } catch (err) {
                console.error('Error sending data:', err);
                tg.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö');
            }
        });
        
        // Handle back button
        tg.onEvent('backButtonClicked', () => {
            tg.close();
        });
        
        // Show back button if cards are selected
        function updateBackButton() {
            if (selectedCards.length > 0) {
                tg.BackButton.show();
            } else {
                tg.BackButton.hide();
            }
        }
        
        // Update back button on selection change
        const originalUpdateUI = updateUI;
        updateUI = function() {
            originalUpdateUI();
            updateBackButton();
        };
        
        // Initialize app when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // Refresh when app becomes visible
                updateUI();
            }
        });
        
        // Handle errors
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            tg.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏');
        });
        
        // Prevent context menu on long press
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
        
        // Prevent text selection
        document.addEventListener('selectstart', (e) => {
            e.preventDefault();
        });
    </script>
</body>
</html>